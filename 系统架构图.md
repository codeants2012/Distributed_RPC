## 用Python构建分布式高并发的RPC框架

------

> **该项目的系统工作流程图大概如下图所示**，下面将从服务端和客户端分别说明系统的工作流程

![3RD8N8.jpg](https://s2.ax1x.com/2020/03/02/3RD8N8.jpg)

### 一、服务端工作流程

#### 1.Prefork异步模型构建

> 采用PreForking模型可以对子进程的数量进行限制，它通过预先产生多个子进程，共同对服务器的套接字

进行竞争性的accept,当一个连接带来时，每个进程都有机会拿到这个连接，但最终只有一个进程accept成功，

进程内部可以继续使用单线程或者多线程进行处理

#### 2.进程管理

+ 父进程需要设置 SIGCHLD 信号处理函数收割意外退出的子进程，避免僵尸进程的出现

+ 父进程需要在进程退出之前杀死所有子进程并收割它们

+ 父进程需要在退出时关闭 zk 会话，立即释放临时节点

+ 父进程需要考虑 waitpid 被其它信号处理函数打断时进行重试

+ 父进程在杀死子进程时有可能遇到子进程已经提前死掉了，要进行异常捕获

#### 3.服务注册

> 所谓服务注册就是服务节点在启动时将自己的服务地址注册到分布式的数据库中，在这个进程结束时

能够主动关闭zk的会话。这里服务端创建的是顺序的临时节点，顺序就是节点名称后会自增id,避免节点的

重复

>  因为Zookeeper的会话支持连接断开重连，所以可以使用临时节点。短时间的连接断开并不会立即删除

内存会话，而是有个过期时间，时间一到，会话自动过期。如果进程突然关闭，Zookeeper将通过会话自动

过期机制关闭会话

#### 4.请求处理

> 每一个进程在接受到请求后，会根据请求参数调用对应的RPC服务函数，计算结果并返回给客户端。

具体的RPC服务可以自定义，这里提供了3种服务，简单的ping测试、根据n值计算圆周率、根据n值计

算斐波那契数列

#### 5.横向扩展

> 服务端的程序可以运行成多个实例，监听不同的端口，共同对外提供服务

### 二、客户端工作流程

#### 1.初始化服务节点列表

> 初始化情况客户端需要从数据库种获取服务节点的列表，并保存在本地

#### 2.服务节点列表变更

> 客户端通过监听zookeeper，当服务节点列表变动时，客户端会收到对应的通知，进而重新加载服务列表

#### 3.发送请求和接收请求

> 在众多的服务节点列表中，客户端会随机选择服务节点，发送请求，接收回应